<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Synthwave Ace</title>
    <style>
        :root { --neon-pink: #ff00ff; --neon-blue: #00ffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #050010; color: #fff; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        #game-container { position: relative; width: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas { background: #000; border-bottom: 2px solid var(--neon-blue); image-rendering: pixelated; width: 100%; height: auto; max-height: 60vh; }

        /* Mobile-First Controls */
        #ui-layer { position: fixed; bottom: 0; width: 100%; height: 150px; background: rgba(10, 0, 30, 0.8); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 20; padding: 10px; }
        .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.05); border: 3px solid var(--neon-pink); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; user-select: none; }
        .btn:active { background: var(--neon-pink); color: #000; box-shadow: 0 0 20px var(--neon-pink); }
        #btnFire { border-color: var(--neon-blue); width: 100px; height: 100px; border-radius: 50%; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .hidden { display: none !important; }
        button#start-btn { background: var(--neon-blue); color: #000; border: none; padding: 25px 50px; font-size: 1.8rem; font-weight: bold; cursor: pointer; border-radius: 10px; }
        .stats { position: fixed; top: 10px; font-size: 1.4rem; color: var(--neon-pink); z-index: 30; font-weight: bold; }
    </style>
</head>
<body>

    <div class="stats">SCORE: <span id="scoreVal">0</span></div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="menuScreen" class="overlay">
            <h1 style="color: var(--neon-pink); font-size: 2.5rem; margin-bottom: 20px;">SYNTH ATTACK</h1>
            <button id="start-btn">TAP TO START</button>
            <p style="margin-top: 20px; font-size: 0.8rem; opacity: 0.7;">V1.4 MOBILE OPTIMIZED</p>
        </div>

        <div id="endScreen" class="overlay hidden">
            <h1 id="endTitle" style="font-size: 2.5rem;">GAME OVER</h1>
            <button id="retry-btn" style="background:var(--neon-pink); padding: 15px 40px; border:none; color:#000; font-weight:bold; font-size: 1.2rem;">REBOOT</button>
        </div>
    </div>

    <div id="ui-layer">
        <div class="btn" id="btnLeft">‚Üê</div>
        <div class="btn" id="btnFire">üî•</div>
        <div class="btn" id="btnRight">‚Üí</div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreVal = document.getElementById('scoreVal');
    
    canvas.width = 600; canvas.height = 700; // Taller for mobile

    let audioCtx;
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSynth(freq, vol, type, duration, sweep) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        if(sweep) osc.frequency.exponentialRampToValueAtTime(sweep, audioCtx.currentTime + duration);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    // --- SYNTHWAVE MUSIC (LONG MELODY) ---
    let musicTick = 0;
    const melody = [329, 0, 329, 349, 392, 0, 392, 349, 329, 293, 261, 261, 293, 329, 329, 293]; 
    const bass = [82, 82, 82, 82, 65, 65, 65, 65, 73, 73, 73, 73, 82, 82, 82, 82];

    function synthMusicLoop() {
        if (!gameActive) return;
        if (musicTick % 10 === 0) {
            let idx = (musicTick / 10) % melody.length;
            // Kick
            if(idx % 4 === 0) playSynth(50, 0.15, 'sine', 0.1, 20);
            // Bass
            playSynth(bass[idx], 0.06, 'sawtooth', 0.2);
            // Melody
            if(melody[idx] > 0) playSynth(melody[idx], 0.03, 'triangle', 0.4);
        }
        musicTick++;
    }

    // --- DRAWING ---
    function drawPlayer(x, y) {
        ctx.fillStyle = '#0f0';
        ctx.beginPath();
        ctx.moveTo(x + 20, y); // Tip
        ctx.lineTo(x, y + 30); // Left back
        ctx.lineTo(x + 40, y + 30); // Right back
        ctx.closePath();
        ctx.fill();
        // Thruster glow
        ctx.fillStyle = 'rgba(0, 255, 255, 0.5)';
        ctx.fillRect(x + 15, y + 30, 10, 5);
    }

    function drawEnemy(x, y) {
        ctx.fillStyle = '#ff00ff';
        ctx.beginPath();
        ctx.arc(x+15, y+10, 10, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#00ffff';
        ctx.fillRect(x+5, y+8, 20, 4);
    }

    // --- GAME LOGIC ---
    let score, gameActive, player, enemies, pBullets, stars, enemyDir, enemySpeed;
    const keys = {};

    function setupGame() {
        initAudio();
        score = 0; gameActive = true; enemyDir = 1; enemySpeed = 1.2;
        pBullets = []; enemies = [];
        player = { x: 280, y: 600, w: 40, h: 30 };
        stars = Array.from({length: 40}, () => ({x: Math.random()*600, y: Math.random()*700, s: Math.random()*3+1}));
        for(let i=0; i<7; i++) for(let j=0; j<4; j++) enemies.push({x: i*75+40, y: j*50+80, w: 30, h: 20, alive: true});
        
        document.getElementById('menuScreen').classList.add('hidden');
        document.getElementById('endScreen').classList.add('hidden');
        loop();
    }

    document.getElementById('start-btn').onclick = setupGame;
    document.getElementById('retry-btn').onclick = setupGame;

    function shoot() {
        if(!gameActive) return;
        pBullets.push({ x: player.x+18, y: player.y });
        playSynth(600, 0.1, 'square', 0.1, 150);
    }

    // Input
    window.addEventListener('keydown', e => { if(e.code === 'Space') shoot(); keys[e.code] = true; });
    window.addEventListener('keyup', e => keys[e.code] = false);

    // Mobile Event Listeners
    const trigger = (btn, key) => {
        btn.ontouchstart = (e) => { e.preventDefault(); keys[key] = true; };
        btn.ontouchend = () => keys[key] = false;
    };
    trigger(document.getElementById('btnLeft'), 'ArrowLeft');
    trigger(document.getElementById('btnRight'), 'ArrowRight');
    document.getElementById('btnFire').ontouchstart = (e) => { e.preventDefault(); shoot(); };

    function loop() {
        if (!gameActive) return;
        update();
        draw();
        synthMusicLoop();
        requestAnimationFrame(loop);
    }

    function update() {
        if (keys['ArrowLeft'] && player.x > 0) player.x -= 7;
        if (keys['ArrowRight'] && player.x < 560) player.x += 7;

        let edge = false;
        enemies.forEach(e => {
            if(!e.alive) return;
            e.x += enemyDir * enemySpeed;
            if(e.x < 10 || e.x > 560) edge = true;

            // LOSE: If enemy touches player
            if(e.x < player.x+player.w && e.x+e.w > player.x && e.y < player.y+player.h && e.y+e.h > player.y) {
                gameOver("COLLISION DETECTED");
            }
            // LOSE: If enemy hits bottom
            if(e.y > 650) gameOver("PLANET INVADED");
        });

        if(edge) { enemyDir *= -1; enemies.forEach(e => e.y += 25); enemySpeed += 0.05; }

        pBullets = pBullets.filter(b => {
            b.y -= 12;
            let hit = false;
            enemies.forEach(e => {
                if(e.alive && b.x > e.x && b.x < e.x+30 && b.y > e.y && b.y < e.y+20) {
                    e.alive = false; hit = true; score += 10; scoreVal.innerText = score;
                    playSynth(100, 0.2, 'sawtooth', 0.3, 20); // Deep Thud
                }
            });
            return b.y > 0 && !hit;
        });

        stars.forEach(s => { s.y += s.s; if(s.y > 700) s.y = 0; });
        if (enemies.every(e => !e.alive)) gameOver("SYSTEMS CLEAR");
    }

    function gameOver(txt) {
        gameActive = false;
        document.getElementById('endScreen').classList.remove('hidden');
        document.getElementById('endTitle').innerText = txt;
        playSynth(40, 0.5, 'sawtooth', 0.8, 10);
    }

    function draw() {
        ctx.fillStyle = '#050010'; ctx.fillRect(0, 0, 600, 700);
        ctx.fillStyle = '#222'; stars.forEach(s => ctx.fillRect(s.x, s.y, s.s, s.s));
        drawPlayer(player.x, player.y);
        enemies.forEach(e => { if(e.alive) drawEnemy(e.x, e.y); });
        ctx.fillStyle = varColor('--neon-blue'); pBullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 15));
    }

    function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }
</script>
</body>
</html>
