<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Attack: Ultra Juiced</title>
    <style>
        body { background: #050505; color: #0f0; font-family: 'Courier New', monospace; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-container { position: relative; }
        canvas { border: 4px solid #444; background: #000; box-shadow: 0 0 50px rgba(0, 255, 0, 0.15); image-rendering: pixelated; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .hidden { display: none; }
        button { background: #0f0; color: #000; border: none; padding: 15px 40px; font-family: inherit; font-weight: bold; font-size: 1.5rem; cursor: pointer; margin-top: 20px; box-shadow: 5px 5px #070; transition: 0.1s; }
        button:hover { background: #fff; transform: scale(1.05); }
        .stats { position: absolute; top: 15px; width: 100%; text-align: center; font-size: 1.5rem; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="stats">SCORE: <span id="scoreVal">0</span></div>
        <canvas id="gameCanvas"></canvas>

        <div id="menuScreen" class="overlay">
            <h1 style="color: #fff; font-size: 4rem; margin: 0; text-shadow: 4px 4px #f0f;">SPACE ATTACK</h1>
            <p style="font-size: 1.2rem;">ARROWS: MOVE | SPACE: FIRE</p>
            <button onclick="startGame()">PRESS START</button>
        </div>

        <div id="endScreen" class="overlay hidden">
            <h1 id="endTitle" style="font-size: 3rem;">SYSTEM OFFLINE</h1>
            <button onclick="startGame()">RETRY</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreVal = document.getElementById('scoreVal');
    const menuScreen = document.getElementById('menuScreen');
    const endScreen = document.getElementById('endScreen');
    
    canvas.width = 600; canvas.height = 450;

    // --- ENHANCED AUDIO ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(freq, sweep, type, vol, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        if(sweep) osc.frequency.exponentialRampToValueAtTime(sweep, audioCtx.currentTime + duration);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    // White Noise for Crunchy Explosions
    function playExplosionSound() {
        const bufferSize = audioCtx.sampleRate * 0.2;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const noiseGain = audioCtx.createGain();
        noiseGain.gain.setValueAtTime(0.4, audioCtx.currentTime); // LOUD
        noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        noise.connect(noiseGain); noiseGain.connect(audioCtx.destination);
        noise.start();
    }

    // Better 8-bit Music (Two tracks)
    let musicTick = 0;
    const bassline = [110, 110, 146, 164, 110, 110, 146, 98];
    const melody = [440, 0, 440, 523, 587, 0, 587, 659];

    function playMusic() {
        if (!gameActive) return;
        if (musicTick % 12 === 0) {
            // Play Bass
            playSound(bassline[(musicTick/12) % 8], 40, 'square', 0.05, 0.1);
            // Play Melody on high ticks
            if(musicTick % 24 === 0) {
                const note = melody[(musicTick/24) % 8];
                if(note > 0) playSound(note, note*0.8, 'triangle', 0.03, 0.15);
            }
        }
        musicTick++;
    }

    // --- SCREEN SHAKE ---
    let shakeIntensity = 0;
    function triggerShake(amt) { shakeIntensity = amt; }

    // --- GAME STATE ---
    let score, gameActive, enemies, pBullets, eBullets, player, enemyDir, enemySpeed, particles, stars;
    const keys = {};

    function startGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        score = 0; gameActive = true; enemyDir = 1; enemySpeed = 1.2; shakeIntensity = 0;
        pBullets = []; eBullets = []; enemies = []; particles = [];
        player = { x: 280, y: 400, w: 40, h: 15 };
        stars = Array.from({length: 80}, () => ({x: Math.random()*600, y: Math.random()*450, s: Math.random()*2+1}));
        
        scoreVal.innerText = score;
        for(let i=0; i<8; i++) for(let j=0; j<3; j++) enemies.push({x: i*65+40, y: j*40+60, w: 30, h: 20, alive: true});
        
        menuScreen.classList.add('hidden'); endScreen.classList.add('hidden');
        loop();
    }

    window.addEventListener('keydown', e => {
        if(e.code === 'Space' && !keys['Space'] && gameActive) {
            pBullets.push({ x: player.x+18, y: player.y, w: 4, h: 12 });
            playSound(900, 200, 'square', 0.15, 0.1); // LOUDER Laser
        }
        keys[e.code] = true;
    });
    window.addEventListener('keyup', e => keys[e.code] = false);

    function loop() {
        if (!gameActive) return;
        update();
        draw();
        playMusic();
        requestAnimationFrame(loop);
    }

    function update() {
        if (keys['ArrowLeft'] && player.x > 0) player.x -= 6;
        if (keys['ArrowRight'] && player.x < canvas.width-40) player.x += 6;

        // Enemy Logic
        let turn = false;
        enemies.forEach(e => {
            if(!e.alive) return;
            e.x += enemyDir * enemySpeed;
            if(e.x < 10 || e.x > 560) turn = true;
        });
        if(turn) { enemyDir *= -1; enemies.forEach(e => e.y += 10); enemySpeed += 0.05; }

        // Enemy Shots
        if(Math.random() < 0.02) {
            const live = enemies.filter(e => e.alive);
            if(live.length) {
                const s = live[Math.floor(Math.random()*live.length)];
                eBullets.push({x: s.x+15, y: s.y+20});
                playSound(150, 400, 'sawtooth', 0.05, 0.1);
            }
        }

        // Bullet Physics
        pBullets = pBullets.filter(b => {
            b.y -= 10;
            let hit = false;
            enemies.forEach(e => {
                if(e.alive && b.x > e.x && b.x < e.x+30 && b.y > e.y && b.y < e.y+20) {
                    e.alive = false; hit = true; score += 10; scoreVal.innerText = score;
                    playExplosionSound();
                    triggerShake(8);
                    for(let i=0; i<15; i++) particles.push({x: e.x+15, y: e.y+10, vx: Math.random()*6-3, vy: Math.random()*6-3, life: 1});
                }
            });
            return b.y > 0 && !hit;
        });

        eBullets = eBullets.filter(b => {
            b.y += 5;
            if(b.x > player.x && b.x < player.x+40 && b.y > player.y && b.y < player.y+15) {
                gameActive = false;
                triggerShake(20);
                endScreen.classList.remove('hidden');
                playSound(60, 10, 'sawtooth', 0.5, 0.6);
            }
            return b.y < 450;
        });

        particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life -= 0.03; });
        particles = particles.filter(p => p.life > 0);
        stars.forEach(s => { s.y += s.s; if(s.y > 450) s.y = 0; });
        if(shakeIntensity > 0) shakeIntensity *= 0.9; 
    }

    function draw() {
        ctx.save();
        // --- APPLY SHAKE ---
        if(shakeIntensity > 0.5) {
            ctx.translate(Math.random()*shakeIntensity - shakeIntensity/2, Math.random()*shakeIntensity - shakeIntensity/2);
        }

        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 600, 450);
        
        // Stars
        ctx.fillStyle = '#444';
        stars.forEach(s => ctx.fillRect(s.x, s.y, s.s/2, s.s/2));

        // Player
        ctx.fillStyle = '#0f0';
        ctx.fillRect(player.x+15, player.y, 10, 5);
        ctx.fillRect(player.x, player.y+5, 40, 10);

        // Enemies
        enemies.forEach(e => {
            if(e.alive) {
                ctx.fillStyle = '#f0f';
                ctx.fillRect(e.x+5, e.y, 20, 5);
                ctx.fillRect(e.x, e.y+5, 30, 10);
                ctx.fillRect(e.x+5, e.y+15, 5, 5); ctx.fillRect(e.x+20, e.y+15, 5, 5);
            }
        });

        // Bullets
        ctx.fillStyle = '#fff'; pBullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 12));
        ctx.fillStyle = '#f00'; eBullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 10));

        // Explosion Particles
        particles.forEach(p => {
            ctx.fillStyle = `rgba(255, 200, 0, ${p.life})`;
            ctx.fillRect(p.x, p.y, 3, 3);
        });

        ctx.restore();
    }
</script>
</body>
</html>
